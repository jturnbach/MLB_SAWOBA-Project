---
title: "Final Model Comparison Measurements"
output: html_document
date: "2024-03-24"
---

```{r, message=FALSE, warning=FALSE}

# Set working directory
wd <- "C:/Users/John/Documents/GitHub/DS440/" # Change as needed

# Load libraries
library(tidyverse)
library(scales)
library(wCorr)
library(knitr)
library(ggplot2)

# Read in data
xwoba_saxwoba <- read.csv(paste0(wd, "project/volume/data/processed/xwoba_saxwoba.csv"))
```

## Calculate Descriptiveness
weights = woba denominator
```{r, message=FALSE, warning=FALSE}

descriptiveness <- function(woba_type, year) {
  
  # Separate data by year
  data <- xwoba_saxwoba[xwoba_saxwoba$game_year == year, ]
  
  # Weighted Spearman Correlation
  wsc <- weightedCorr(data[[woba_type]],
                         data$woba, 
                         weights = data$woba_denom, 
                         method = "spearman")
  
  return(wsc)
  
}

# 2021
desc_xwoba_21 <- descriptiveness('est_woba', 2021)
desc_saxwoba_21 <- descriptiveness('sa_xwoba', 2021)

# 2022
desc_xwoba_22 <- descriptiveness('est_woba', 2022)
desc_saxwoba_22 <- descriptiveness('sa_xwoba', 2022)

# 2023
desc_xwoba_23 <- descriptiveness('est_woba', 2023)
desc_saxwoba_23 <- descriptiveness('sa_xwoba', 2023)

```

## Calulate Harmonic Mean
```{r, message=FALSE, warning=FALSE}
harmonic_mean <- function(a, b) {
  return(2 * (a * b) / (a + b))
}

names <- c("player_id", "est_woba", "sa_xwoba", "woba", "woba_denom")

# Create Season Dataframes
xwoba_21_22 <- merge(xwoba_saxwoba[xwoba_saxwoba$game_year == 2021, names],
                     xwoba_saxwoba[xwoba_saxwoba$game_year == 2022, names],
                     by = "player_id", suffixes = c("_21", "_22"))

xwoba_22_23 <- merge(xwoba_saxwoba[xwoba_saxwoba$game_year == 2022, names], 
                     xwoba_saxwoba[xwoba_saxwoba$game_year == 2023, names],
                     by = "player_id", suffixes = c("_22", "_23"))

# Calculate harmonic weights
xwoba_21_22$harmonic_weights <- mapply(harmonic_mean, xwoba_21_22$woba_denom_21, xwoba_21_22$woba_denom_22)
xwoba_22_23$harmonic_weights <- mapply(harmonic_mean, xwoba_22_23$woba_denom_22, xwoba_22_23$woba_denom_23)

```

## Calculate Predictiviness
weights = harmonic mean
```{r, message=FALSE, warning=FALSE}
# Calculate Predictiveness
pred_xwoba_21_22 <- weightedCorr(xwoba_21_22$est_woba_21, 
                                 xwoba_21_22$woba_22, 
                                 weights = xwoba_21_22$harmonic_weights, 
                                 method = "spearman")

pred_xwoba_22_23 <- weightedCorr(xwoba_22_23$est_woba_22, 
                                 xwoba_22_23$woba_23, 
                                 weights = xwoba_22_23$harmonic_weights, 
                                 method = "spearman")

pred_saxwoba_21_22 <- weightedCorr(xwoba_21_22$sa_xwoba_21, 
                                   xwoba_21_22$woba_22, 
                                   weights = xwoba_21_22$harmonic_weights, 
                                   method = "spearman")

pred_saxwoba_22_23 <- weightedCorr(xwoba_22_23$sa_xwoba_22, 
                                   xwoba_22_23$woba_23, 
                                   weights = xwoba_22_23$harmonic_weights, 
                                   method = "spearman")

```

## Calculate Reliability
weights = harmonic mean
```{r, message=FALSE, warning=FALSE}
#Calculate Reliability
rel_xwoba_21_22 <- weightedCorr(xwoba_21_22$est_woba_21, 
                                 xwoba_21_22$est_woba_22, 
                                 weights = xwoba_21_22$harmonic_weights, 
                                 method = "spearman")

rel_saxwoba_21_22 <- weightedCorr(xwoba_21_22$sa_xwoba_21, 
                                 xwoba_21_22$sa_xwoba_22, 
                                 weights = xwoba_21_22$harmonic_weights, 
                                 method = "spearman")

rel_xwoba_22_23 <- weightedCorr(xwoba_22_23$est_woba_22, 
                                 xwoba_22_23$est_woba_23, 
                                 weights = xwoba_22_23$harmonic_weights, 
                                 method = "spearman")

rel_saxwoba_22_23 <- weightedCorr(xwoba_22_23$sa_xwoba_22, 
                                 xwoba_22_23$sa_xwoba_23, 
                                 weights = xwoba_22_23$harmonic_weights, 
                                 method = "spearman")

```

```{r, message=FALSE, warning=FALSE}
# Create a dataframe for descriptiveness results
desc_results <- data.frame(
  Year = c("2021", "2022", "2023"),
  xwOBA_Descriptiveness = c(desc_xwoba_21, desc_xwoba_22, desc_xwoba_23),
  sa_xwOBA_Descriptiveness = c(desc_saxwoba_21, desc_saxwoba_22, desc_saxwoba_23)
)

# Find average descriptiveness
desc_results <- rbind(desc_results, c("Average", mean(desc_results$xwOBA_Descriptiveness, na.rm = TRUE), mean(desc_results$sa_xwOBA_Descriptiveness, na.rm = TRUE)))

# Create a dataframe for predictiveness and reliability results
pred_rel_results <- data.frame(
  Year = c("2021-2022", "2022-2023"),
  xwOBA_Predictiveness = c(pred_xwoba_21_22, pred_xwoba_22_23),
  sa_xwOBA_Predictiveness = c(pred_saxwoba_21_22, pred_saxwoba_22_23),
  xwOBA_Reliability = c(rel_xwoba_21_22, rel_xwoba_22_23),
  sa_xwOBA_Reliability = c(rel_saxwoba_21_22, rel_saxwoba_22_23)
)

write.csv(desc_results, paste0(wd, "project/volume/data/processed/desc.csv"))
write.csv(pred_rel_results, paste0(wd, "project/volume/data/processed/pred_and_rel.csv"))

```

## Descriptiveness Results
```{r, message=FALSE, warning=FALSE}
kable(desc_results)
```
```{r}
desc_long <- reshape2::melt(desc_results, id.vars = "Year", variable.name = "Measure", value.name = "Correlation")
desc_long$Correlation <- as.numeric(as.character(desc_long$Correlation))

ggplot(desc_long, aes(x = Year, y = Correlation, fill = Measure)) + 
  geom_bar(stat = "identity", position = position_dodge()) +
  theme_minimal() +
  labs(title = "Descriptiveness of xwOBA and sa-xwOBA",
       x = "Year",
       y = "Correlation",
       fill = "Measure") +
  scale_fill_manual(values = c("xwOBA_Descriptiveness" = "blue", "sa_xwOBA_Descriptiveness" = "red")) +
  scale_y_continuous(limits = c(0, 1))
```

## Predictiveness and Reliability Results
```{r, message=FALSE, warning=FALSE}
kable(pred_rel_results)  
```
